<!DOCTYPE HTML>
<html lang="en">
    <head>
        <meta charset="UTF-8"/>
        <title>Stats for application: {{app.name}}</title>
        <!-- Google fonts -->
        <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:200,300' rel='stylesheet' type='text/css'>
        <!-- Leaflet maps -->
        <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.4/leaflet.css" />
         <!--[if lte IE 8]>
             <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.4/leaflet.ie.css" />
         <![endif]-->
        <!-- Default Style -->
        <script src="http://cdn.leafletjs.com/leaflet-0.4/leaflet.js"></script>

        <style>
        {% include "css/style.css" %}
        {% include "css/bootstrap.css" %}
        {% include "css/nv.d3.css" %}
        {% include "css/MarkerCluster.css" %}
        {% include "css/MarkerCluster.Default.css" %}
        </style>
        <!-- Graph toolkits -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
        <script src="http://d3js.org/d3.v2.js"></script>
        <script>
        {% include "js/nv.d3.min.js" %}
        </script>
        <script src="Stats.json"></script>
        <script>
            {% include "js/leaflet.markercluster.js" %}
        </script>
    </head>
    <body>
        <div class="container-fluid">
            <div id="heading" class="row-fluid">
                {% if app.info.thumbnail %}
                <div class="span1">
                    <img class="img-polaroid" src="{{app.info.thumbnail}}"/>
                </div>
                <div class="span11">
                    <h1 >Stats for application: <small style="font-size:32px">{{app.name}}</small></h1>
                </div>
                {% else %}
                <div class="span12">
                    <h1 >Stats for application: <small style="font-size:32px">{{app.name}}</small></h1>
                </div>
                {% endif %}
            </div>

            {% if private %}
            <div class="row-fluid">
                <div class="span12 well">
                    <p style="font-size:30px;line-height:34px;"><strong>Important:</strong> Data have been <strong>anonymized!</strong></p>
                </div>
            </div>

            {% endif %}

            <!-- Hour Stats CARD -->
            <div id="card" class="row-fluid">
                <div class="span12  well">
                    <h2>Distribution of Answers per Hour</h2>
                    <div id="hourStats" style="margin:0">
                    <svg style="height:500px;"></svg>
                    </div>
                    <script>
                    nv.addGraph(function() {
                      var data = appStats.hourStats;
                      var chart = nv.models.scatterChart()
                                    .showDistX(true)
                                    .showDistY(true)
                                    .color(d3.scale.category10().range());
                    
                      chart.xAxis
                        .axisLabel('Hours')
                        .tickFormat(d3.format('i'));
                      chart.yAxis
                        .axisLabel('Answers')
                        .tickFormat(d3.format('s'));
                    
                       d3.select('#hourStats svg')
                          .datum(data)
                        .transition().duration(500)
                          .call(chart);
                    
                      nv.utils.windowResize(chart.update);
                    
                      return chart;
                    });
                    </script>
                </div>
            </div>
            <!-- END Hour Stats CARD -->

            <!-- Day Stats CARD -->
            <div id="card" class="row-fluid">
                <div  class="span12  well">
                    <h2>Answers per day</h2>
                    <div id="dayStats" style="margin:0">
                    <svg style="height:400px;"></svg>
                    </div>
                    <script>
                        nv.addGraph(function() {
                            var data = appStats.dayStats;
                            var chart = nv.models.lineWithFocusChart()
                                  .margin({top: 30, right: 35, bottom: 50, left: 35})
                                  .x(function(d,i) { return i })
                                  .y(function(d) { return d[1] })
                                  .color(d3.scale.category10().range());
                        
                            chart.xAxis
                              .showMaxMin(true)
                              .axisLabel('Days')
                              .tickFormat(function(d) {
                                var dx = data[0].values[d] && data[0].values[d][0] || 0;
                                if (dx!=0) {
                                    return d3.time.format('%y-%m-%d')(new Date(dx))
                                }
                              });

                            chart.x2Axis
                              .showMaxMin(true)
                              .tickFormat(function(d) {
                                var dx = data[0].values[d] && data[0].values[d][0] || 0;
                                if (dx!=0) {
                                    return d3.time.format('%y-%m-%d')(new Date(dx))
                                }
                              });


                            chart.yAxis
                                .axisLabel('Answers')
                                .tickFormat(d3.format(',s'));
                        
                            chart.y2Axis
                                .tickFormat(d3.format(',s'));
                        
                            d3.select('#dayStats svg')
                                .datum(data)
                              .transition().duration(500).call(chart);
                        
                            nv.utils.windowResize(chart.update);
                        
                            return chart;
                        });
                    </script>
                </div>
            </div>
            <!-- END Day Stats CARD -->


            <!-- Number of answers CARD -->
            <div id="card" class="row-fluid">
                <div id="dist-answers" class="span12  well">
                    <h2>Distribution of Answers</h2>
                    <div class="row-fluid">
                        <div class="span6">
                            <table class="table table-hover table-bordered table-striped">
                                <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>Tasks</th>
                                        <th>Percentage</th>
                                    </tr>
                                </thead>
                            {% for k in userStats.keys() %}
                                <tr>
                                    <th>{{k | capitalize}}</th>
                                    <th>{{userStats[k].taskruns}}</th>
                                    <th>{{userStats[k].pct_taskruns}} %</th>
                                </tr>
                            {% endfor %}
                            </table>

                        </div>
                        <div id="userAnsStats" class="span4">
                            <svg style='height:250px;width:250px'></svg>
                        </div>
                        <script>
                            nv.addGraph(function() {
                                var chart = nv.models.pieChart()
                                    .color(d3.scale.category10().range().slice(1,3))
                                .margin({top:-60})
                                    .x(function(d) { return d.label })
                                    .y(function(d) { return d.value })
                                    .showLabels(true)
                                    .showLegend(false)
                                    .labelThreshold(.05)
                                    .donut(true);

                                d3.select("#userAnsStats svg")
                                    .datum([appStats.userStats])
                                    .transition().duration(12000)
                                    .call(chart);

                              nv.utils.windowResize(chart.update);
                              return chart;
                            });
                        </script>
                    </div>
                </div>
            </div>
            <!-- END Number of Answers Stats CARD -->

            <!-- Anon User Stats CARD -->
            <div id="card" class="row-fluid">
                <div id="dist-anon" class="span12  well">
                    <h2>Details about Anonymous Users</h2>
                    <div class="row-fluid">
                        <div class="span6">
                            <p><strong>{{userStats.anonymous.users}} </strong> have <strong>participated</strong>.</p>
                            {% if userStats.anonymous.top5 %}
                            <h4>Top 5 users</h4>
                            <table class="table table-hover table-bordered table-striped">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>IP Address</th>
                                        <th>Country</th>
                                        <th>City</th>
                                        <th>Tasks</th>
                                    </tr>
                                </thead>
                            {% for u in userStats.anonymous.top5 %}
                                <tr>
                                    <th>{{loop.index}}</th>
                                    <th>{{u.ip}}</th>
                                    <th>{{u.loc.country_name}}</th>
                                    <th>{{u.loc.city}}</th>
                                    <th>{{u.tasks}}</th>
                                </tr>
                            {% endfor %}
                            </table>
                            {% endif %}
                        </div>
                        <div id="userStats" class="span4">
                            <svg style='height:400px;width:400px'></svg>
                        </div>
                        <script>
                            nv.addGraph(function() {
                                var chart = nv.models.pieChart()
                                    .color(d3.scale.category20().range())
                                .margin({top:-60})
                                    .x(function(d) { return d.label })
                                    .y(function(d) { return d.value })
                                    .showLabels(false)
                                    .showLegend(false)
                                    .labelThreshold(.05)
                                    .donut(true);

                                d3.select("#userStats svg")
                                    .datum([appStats.userAnonStats])
                                    .transition().duration(12000)
                                    .call(chart);

                              nv.utils.windowResize(chart.update);
                              return chart;
                            });
                        </script>
                    </div>
                    <div class="row-fluid">
                        <div class="span12">
                            <div id="map" style="height:250px;"></div>
                        </div>
                        <script>
                            var map = L.map('map');
                            map.fitWorld();
                            map.setZoom(1);
                            var url = 'http://{s}.tile.cloudmade.com/f9ed30886bf3454691669c63a45490f4/997/256/{z}/{x}/{y}.png'
                            L.tileLayer(url, 
                                {
                                attribution: 'Map data Cloudmade.com &copy;',
                                maxZoom: 18,
                                minZoom:1
                                }).addTo(map);

                            var i = 0;
                            var locations = appStats.userAnonStats.locs;
                            var l = locations.length;
                            var markers = new L.MarkerClusterGroup();
                            for (i;i<l;i++) {
                                var lat = parseFloat(locations[i].loc.latitude);
                                var lng = parseFloat(locations[i].loc.longitude);
                                markers.addLayer(L.marker([lat,lng]));
                            }
                            map.addLayer(markers);

                        </script>
                    </div>
                </div>
            </div>
            <!-- END Anon User Stats CARD -->

            <!-- Auth User Stats CARD -->
            <div id="card" class="row-fluid">
                <div id="dist-auth" class="span12  well">
                    <h2>Details about Authenticated Users</h2>
                    <div class="row-fluid">
                        <div class="span6">
                            <p><strong>{{userStats.authenticated.users}} </strong> have <strong>participated</strong>.</p>
                            {% if userStats.authenticated.top5 %}
                            <h4>Top 5 users</h4>
                            <table class="table table-hover table-bordered table-striped">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>PyBossa User ID</th>
                                        <th>Tasks</th>
                                    </tr>
                                </thead>
                            {% for u in userStats.authenticated.top5 %}
                                <tr>
                                    <th>{{loop.index}}</th>
                                    <th>{{u[0]}}</th>
                                    <th>{{u[1]}}</th>
                                </tr>
                            {% endfor %}
                            </table>
                            {% endif %}
                        </div>
                        <div id="authStats" class="span4">
                            <svg style='height:400px;width:400px'></svg>
                        </div>
                        <script>
                            nv.addGraph(function() {
                                var chart = nv.models.pieChart()
                                    .color(d3.scale.category20().range())
                                .margin({top:-60})
                                    .x(function(d) { return d.label })
                                    .y(function(d) { return d.value })
                                    .showLabels(false)
                                    .showLegend(false)
                                    .labelThreshold(.05)
                                    .donut(true);

                                
                                d3.select("#authStats svg")
                                    .datum([appStats.userAuthStats])
                                    .transition().duration(12000)
                                    .call(chart);

                              nv.utils.windowResize(chart.update);
                              return chart;
                            });
                        </script>
                    </div>
                </div>
            </div>
            <!-- END Auth User Stats CARD -->


        </div>
    </body>
</html> 

